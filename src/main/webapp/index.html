<!DOCTYPE html>
<html>

<head>

    <title>Android Drawable Manager</title>

    <link rel="shortcut icon" href="http://www.1hai.cn/favicon.ico" type="image/x-icon"/>

    <link rel="stylesheet" href="css/bootstrap.min.css">

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
            integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
            crossorigin="anonymous"></script>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
            word-wrap: break-word;
        }

        .carousel-control-prev-icon {
            background-image: url("img/arrow-left.png");
            margin-bottom: 30px;
        }

        .carousel-control-next-icon {
            background-image: url("img/arrow-right.png");
            margin-bottom: 30px;
        }

        a, .list-group-item {
            font-size: 13px;
        }

        .drawable-edit, .drawable-close {
            cursor: pointer;
        }


    </style>

</head>

<body style="width: 100%;">

<nav class="navbar navbar-expand-lg navbar-light bg-faded" style="background-color: #e3f2fd;">

    <div class="collapse navbar-collapse" id="navbar_div1">
        <a class="nav-link" href="http://www.1hai.cn/" style="color: darkorchid" target="_blank">一嗨租车官网<span
                class="sr-only">(current)</span></a>

        <ul class="navbar-nav" id="navbar_ul_menu"><!--  mr-auto -->
            <!--<li class="nav-item">-->
            <!--<a class="nav-link" href="#">一嗨租车 App</a>-->
            <!--</li>-->
            <!--<li class="nav-item">-->
            <!--<a class="nav-link" href="#">司机Pad App</a>-->
            <!--</li>-->
        </ul>
    </div>

    <span id="span_user_info"></span>

    <a id="a_loginout" style="color: cornflowerblue;margin-left: 20px;" href="./login.html">退出登录</a>
    <a id="a_login" style="color: cornflowerblue;margin-left: 20px;" href="./login.html">登录</a>

    <!--<a  style="color: cornflowerblue;margin-left: 10px;" href="#">注册</a>-->

</nav>

<div class="alert alert-primary" role="alert" style="color: red;">
    分类较少的项目,一个类别下面图片太多,会导致拖放的时候有一辆秒的延时! 所以对图片多的资源拖拽的时候请慢一点、耐心一点
</div>

<div style="display: flex;margin-left: 10px;margin-right: 10px;">

    <div style="width: 200px;">
        <!-- List group -->
        <div class="list-group" id="drawabeCategory" role="tablist" style="margin-bottom: 100px;">

            <!--<a class="list-group-item list-group-item-action active" data-toggle="list" href="#home" role="tab">All</a>-->
            <!--<a class="list-group-item list-group-item-action" data-toggle="list" href="#home" role="tab">Home</a>-->
            <!--<a class="list-group-item list-group-item-action" data-toggle="list" href="#profile" role="tab">Profile</a>-->
            <!--<a class="list-group-item list-group-item-action" data-toggle="list" href="#messages" role="tab">Messages</a>-->
            <!--<a class="list-group-item list-group-item-action" data-toggle="list" href="#settings"-->
            <!--role="tab">Settings</a>-->

            <div ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
                 class="list-group-item list-group-item-action active" data-toggle="list">All
            </div>
            <div ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
                 class="list-group-item list-group-item-action" data-toggle="list">Home
            </div>
            <div ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
                 class="list-group-item list-group-item-action" data-toggle="list">Profile
            </div>
            <div ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
                 class="list-group-item list-group-item-action" data-toggle="list">Messages
            </div>
            <div ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
                 class="list-group-item list-group-item-action" data-toggle="list">Settings
            </div>

        </div>
    </div>

    <div class="container-fluid rounded" style="height: 850px;margin-left: 4px;">

        <div id="div_drawable_container">

            <div draggable="true" ondragstart="onDrawableDrag(event)"
                 style="background: white;width :200px;height: 240px;float: left;margin-left: 10px;margin-bottom: 10px;position:relative;">

                <div id="carousel1" class="carousel slide" data-ride="carousel" data-interval="5000"
                     style="width :100%;border-style: solid; border-width: 0.5px;border-color: rgba(180,180,180,0.4);padding-bottom: 10px;">

                    <ol class="carousel-indicators">

                        <li class="active" data-slide-to="0" data-target="#carousel1"></li>
                        <li data-slide-to="1" data-target="#carousel1"></li>

                    </ol>

                    <!--轮播图内部需要显示的东西-->
                    <div class="carousel-inner">

                        <div class="carousel-item active" style="width :100%;text-align:center;">

                            <div style="width :200px;height: 100px;display: table-cell;vertical-align: middle;">

                                <img draggable="true" ondragstart="onDrawableImageDrag(event)"
                                     src="http://h.hiphotos.baidu.com/image/pic/item/2cf5e0fe9925bc31b3e6ab0a52df8db1ca1370ed.jpg"
                                     style="max-width: 100%;max-height: 100%;">

                            </div>

                            <div style="height: 60px;width: 100%;font-size: 14px;text-align: left;padding: 4px;">
                                folder：drawable-xhdpi-xhdpi-xhdpi-xhdpi
                            </div>

                            <div style="height: 20px;width: 100%;font-size: 14px;text-align: left;padding: 4px;">
                                100 * 100
                            </div>

                        </div>

                        <div class="carousel-item" style="width :100%;text-align:center;">


                            <div style="width :200px;height: 100px;display: table-cell;vertical-align: middle;">

                                <img draggable="true" ondragstart="onDrawableImageDrag(event)"
                                     src="http://h.hiphotos.baidu.com/image/pic/item/2cf5e0fe9925bc31b3e6ab0a52df8db1ca1370ed.jpg"
                                     style="max-width: 100%;max-height: 100%;">

                            </div>

                            <div style="height: 60px;width: 100%;font-size: 14px;text-align: left;padding: 4px;">
                                folder：drawable-xhdpi-xhdpi-xhdpi-xhdpi
                            </div>

                            <div style="height: 20px;width: 100%;font-size: 14px;text-align: left;padding: 4px;">
                                100 * 100
                            </div>


                        </div>

                    </div>

                    <a class="carousel-control-prev" role="button" href="#carousel1" data-slide="prev">

                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only"></span>

                    </a>

                    <a class="carousel-control-next" role="button" href="#carousel1" data-slide="next">

                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only"></span>

                    </a>

                </div>

                <h4 class="card-title"
                    style="width: 100%;height: 60px;margin-top: 0px;text-align: left;padding: 4px;font-size: 14px;">
                    name：app_login_icon.png
                </h4>

                <img class="drawable-edit" src="img/edit.png"
                     style="width: 28px;height: 28px;position:absolute;left:0;top:0;margin-left: 5px;margin-top: 5px;">

                <img onclick="onDeleteDrawable()" class="drawable-close" src="img/close.png"
                     style="width: 28px;height: 28px;position:absolute;right:0;top:0;margin-right: 5px;margin-top: 5px;">

            </div>

        </div>

    </div>

</div>

</body>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

<script src="js/image.js"></script>

<script type="text/javascript">

    var carousel_container_tag_key = "data-carousel_container_tag_key";
    var carousel_container_tag_value = "carousel_container_tag";

    var projectDrawable;

    var mapDrawable = {};

    $(document).ready(function () {

        $("#span_user_info").hide()
        $("#a_loginout").hide()

        if (isLogin()) { // 如果token不是null,就去请求用户信息

            req({url: baseUrl + "user?userToken=" + getUserToken()}, function (result) {

                    if (result == null) {
                        saveUserToken(null)
                    } else {
                        $("#span_user_info").show()
                        $("#a_loginout").show()
                        $("#a_login").hide()
                        $("#span_user_info").text(result.name)
                    }

                }, function (msg) {
                    saveUserToken(null)
                }
            )

        }

        // 请求项目的数据
        req({url: baseUrl + "project/list"}, function (result) {

                $("#navbar_ul_menu").innerHTML = "";

                if (result == null || result.length == 0) {
                    return
                }

                var len = result.length;

                for (var i = 0; i < len; i++) {

                    var pro = result[i];

                    $("#navbar_ul_menu")[0].innerHTML += "<li class='nav-item'><a class='nav-link' href='#' onclick='reqProImageList(" + pro.id + ")'>" + pro.name + "</a></li>"

                }

            }
        )

    });

    /**
     * 提交一个删除资源的Action
     */
    function onDeleteDrawable(category, drawablesEntity) {

        req({
                type: 'DELETE',
                url: baseUrl + "action?sourceCategory=" + category.name + "&source=" + drawablesEntity.drawableName
            }, function (result) {

                alert(result);

            }, function (msg) {

                alert("msg = " + msg)

            }
        )

    }

    function reqProImageList(proId) {

        clearCategoryAndDrawables();

        req({url: baseUrl + "project/listImage?proId=" + proId}, function (result) {

                console.log(result)

                showImagesOfProject(result)

            }, function (msg) {
                alert(msg);
            }
        )


    }

    function showImagesOfProject(result) {

        projectDrawable = result;
        mapDrawable = {};

        var categories = result.categories;

        if (categories == null) {
            return;
        }

        var categoryLength = categories.length;

        clearCategoryAndDrawables();

        for (var i = 0; i < categoryLength; i++) {

            var category = categories[i];

            var category_item = createOneCategory(i, category);

            $("#drawabeCategory").append(category_item);

        }

        if (categoryLength > 0) {

            showImagesOfCategory(projectDrawable.categories[0]);

        }

    }

    function showImagesOfCategory(category) {

        var drawablesList = category.drawablesList;

        var drawablesListLength = drawablesList.length;

        $("#div_drawable_container")[0].innerHTML = "";

        for (var i = 0; i < drawablesListLength; i++) {

            var drawablesEntity = drawablesList[i];

            var div_carousel_container = createOneCarousel(category, drawablesEntity, "carousel" + i);

            var key = "carousel_" + category.name + "_" + drawablesEntity.drawableName;

            div_carousel_container.setAttribute("data-key", key);
            div_carousel_container.setAttribute(carousel_container_tag_key, carousel_container_tag_value);

            mapDrawable[key] = drawablesEntity;

            $("#div_drawable_container").append(div_carousel_container);

        }

        $('html,body').animate({scrollTop: '0px'}, 300);

    }

    function clearCategoryAndDrawables() {
        $("#drawabeCategory")[0].innerHTML = "";
        $("#div_drawable_container")[0].innerHTML = "";
    }

    function createOneCategory(categoryIndex, category) {

        var div = document.createElement("div")

        if (categoryIndex == 0) {
            div.setAttribute("class", "list-group-item list-group-item-action active");
        } else {
            div.setAttribute("class", "list-group-item list-group-item-action");
        }
        // ondrop="onDrawableDrog(event)" ondragover="allowDrop(event)"
        div.setAttribute("ondrop", "onDrawableDrog(event)");
        div.setAttribute("ondragover", "allowDrop(event)");
        div.setAttribute("data-toggle", "list");
        //div.setAttribute("onclick", "showImagesOfCategory('" + categoryIndex + "')");
        div.onclick = function (ev) {
            showImagesOfCategory(projectDrawable.categories[categoryIndex])
        }

        div.innerText = category.name;

        return div;

    }

    function createOneCarousel(category, drawablesEntity, tag) {

        var drawables = drawablesEntity.drawables;

        var imageCount = drawables.length;

        var div_carousel_container = document.createElement("div");       // ========================== 0
        // draggable="true" ondragstart="onDrawableDrag(event)"
        div_carousel_container.setAttribute("draggable", "true");
        div_carousel_container.setAttribute("ondragstart", "onDrawableDrag(event)");
        div_carousel_container.setAttribute("style", "background: white;width :200px;height: 240px;float: left;margin-left: 10px;margin-bottom: 10px;position:relative;");

        var div_carousel = document.createElement("div");       // ========================== 1

        div_carousel_container.appendChild(div_carousel);                  // ==========================1 -> 0

        div_carousel.setAttribute("id", tag);
        div_carousel.setAttribute("class", "carousel slide");
        div_carousel.setAttribute("data-ride", "carousel");
        div_carousel.setAttribute("data-interval", "0");
        div_carousel.setAttribute("style", "width :100%;border-style: solid; border-width: 0.5px;border-color: rgba(180,180,180,0.4);padding-bottom: 10px;");

        var ol_carousel = document.createElement("ol");         // ==========================1.1
        ol_carousel.setAttribute("class", "carousel-indicators");

        div_carousel.appendChild(ol_carousel);                  // ==========================1.1 -> 1

        for (var i = 0; i < imageCount; i++) {

            var li_carousel = document.createElement("li");
            if (i == 0) {
                li_carousel.setAttribute("class", "active");
            }
            li_carousel.setAttribute("data-slide-to", "" + i);
            li_carousel.setAttribute("data-target", "#" + tag);

            ol_carousel.appendChild(li_carousel);               // ==========================1.1.* -> 1.1

        }

        var div_carousel_inner = document.createElement("div"); // ==========================1.2
        div_carousel_inner.setAttribute("class", "carousel-inner");

        div_carousel.appendChild(div_carousel_inner);                  // ==========================1.2 -> 1

        for (var i = 0; i < imageCount; i++) {

            var div_carousel_inner_item = document.createElement("div"); // ==========================1.2.*
            if (i == 0) {
                div_carousel_inner_item.setAttribute("class", "carousel-item active");
            } else {
                div_carousel_inner_item.setAttribute("class", "carousel-item");
            }
            div_carousel_inner_item.setAttribute("style", "text-align:center;");

            var div_carousel_inner_item_item = document.createElement("div"); // ==========================1.2.*.1
            // 这个的这个width不能写100%,否则左右居中就不灵了
            div_carousel_inner_item_item.setAttribute("style", "width :200px;height: 100px;display: table-cell;vertical-align: middle;padding: 4px;");

            var img_carousel_inner_item = document.createElement("img"); // ==========================1.2.*.1.*
            img_carousel_inner_item.setAttribute("draggable", "true");
            img_carousel_inner_item.setAttribute("ondragstart", "onDrawableImageDrag(event)");
            //img_carousel_inner_item.setAttribute("class", "d-block w-100 h-100");
            img_carousel_inner_item.setAttribute("style", "max-width: 100%;max-height: 100%;");
            img_carousel_inner_item.setAttribute("src", baseUrl + drawables[i].imagePath);

            div_carousel_inner_item_item.appendChild(img_carousel_inner_item); // ==========================1.2.*.1.* -> ==========================1.2.*.1
            div_carousel_inner_item.appendChild(div_carousel_inner_item_item); // ==========================1.2.*.1 -> ==========================1.2.*

            var div_carousel_inner_item_desc = document.createElement("div"); // ==========================1.2.*.2
            div_carousel_inner_item_desc.setAttribute("style", "height: 60px;width: 100%;font-size: 14px;text-align: left;padding: 4px;")

            if (drawables[i].drawableFolderName == null || drawables[i].drawableFolderName == "") {
                div_carousel_inner_item_desc.innerText = drawables[i].drawableName;
            } else {
                div_carousel_inner_item_desc.innerText = drawables[i].drawableFolderName;
            }

            div_carousel_inner_item.appendChild(div_carousel_inner_item_desc); // ==========================1.2.*.2 -> ==========================1.2.*

            var div_carousel_inner_item_drawable_size = document.createElement("div"); // ==========================1.2.*.3
            div_carousel_inner_item_drawable_size.setAttribute("style", "height: 20px;width: 100%;font-size: 13px;text-align: left;padding: 4px;")
            div_carousel_inner_item_drawable_size.innerText = drawables[i].width + "px * " + drawables[i].height + "px";

            div_carousel_inner_item.appendChild(div_carousel_inner_item_drawable_size); // ==========================1.2.*.3 -> ==========================1.2.*

            div_carousel_inner.appendChild(div_carousel_inner_item);    // ==========================1.2.* -> 1.2

        }

        var a_carousel_control_prev = document.createElement("a"); // ==========================1.3
        a_carousel_control_prev.setAttribute("class", "carousel-control-prev");
        a_carousel_control_prev.setAttribute("href", "#" + tag);
        a_carousel_control_prev.setAttribute("role", "button");
        a_carousel_control_prev.setAttribute("data-slide", "prev");

        var span_carousel_control_prev_icon = document.createElement("span"); // ==========================1.3.1
        span_carousel_control_prev_icon.setAttribute("class", "carousel-control-prev-icon");
        span_carousel_control_prev_icon.setAttribute("aria-hidden", "true");

        var span_carousel_control_prev = document.createElement("span"); // ==========================1.3.2
        span_carousel_control_prev.setAttribute("class", "sr-only");

        a_carousel_control_prev.appendChild(span_carousel_control_prev_icon); // ==========================1.3.1 -> 1.3
        a_carousel_control_prev.appendChild(span_carousel_control_prev); // ==========================1.3.2 -> 1.3

        div_carousel.appendChild(a_carousel_control_prev);                  // ==========================1.3 -> 1

        var a_carousel_control_next = document.createElement("a"); // ==========================1.4
        a_carousel_control_next.setAttribute("class", "carousel-control-next");
        a_carousel_control_next.setAttribute("href", "#" + tag);
        a_carousel_control_next.setAttribute("role", "button");
        a_carousel_control_next.setAttribute("data-slide", "next");

        var span_carousel_control_next_icon = document.createElement("span"); // ==========================1.4.1
        span_carousel_control_next_icon.setAttribute("class", "carousel-control-next-icon");
        span_carousel_control_next_icon.setAttribute("aria-hidden", "true");

        var span_carousel_control_next = document.createElement("span"); // ==========================1.4.2
        span_carousel_control_next.setAttribute("class", "sr-only");

        a_carousel_control_next.appendChild(span_carousel_control_next_icon); // ==========================1.4.1 -> 1.4
        a_carousel_control_next.appendChild(span_carousel_control_next); // ==========================1.4.2 -> 1.4

        div_carousel.appendChild(a_carousel_control_next);                  // ==========================1.4 -> 1

        var h4_drawable_desc = document.createElement("h4");                  // ==========================2
        h4_drawable_desc.setAttribute("style", "width: 100%;height: 60px;margin-top: 0px;text-align: left;padding: 4px;font-size: 13px;");
        h4_drawable_desc.setAttribute("class", "card-title");
        h4_drawable_desc.innerText = drawablesEntity.drawableName;

        div_carousel_container.appendChild(h4_drawable_desc);                  // ==========================2 -> 0

        // <img class="drawable-edit" src="img/edit.png" style="width: 28px;height: 28px;position:absolute;left:0;top:0;margin-left: 5px;margin-top: 5px;">

        var img_edit_drawable = document.createElement("img");                  // ==========================3
        img_edit_drawable.setAttribute("src", "img/edit.png");
        img_edit_drawable.setAttribute("class", "drawable-edit");
        img_edit_drawable.setAttribute("style", "width: 28px;height: 28px;position:absolute;left:0;top:0;margin-left: 5px;margin-top: 5px;");

        div_carousel_container.appendChild(img_edit_drawable);                  // ==========================3 -> 0

        var img_delete_drawable = document.createElement("img");                  // ==========================4
        img_delete_drawable.setAttribute("src", "img/close.png");
        img_delete_drawable.setAttribute("class", "drawable-close");
        //img_delete_drawable.setAttribute("onclick", "onDeleteDrawable()");
        img_delete_drawable.setAttribute("style", "width: 28px;height: 28px;position:absolute;right:0;top:0;margin-right: 5px;margin-top: 5px;");

        img_delete_drawable.onclick = function (ev) {
            onDeleteDrawable(category, drawablesEntity);
        }

        div_carousel_container.appendChild(img_delete_drawable);                  // ==========================4 -> 0

        return div_carousel_container;


    }


    // =============================== 有关拖动的 start===============================

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function onDrawableImageDrag(ev) {
        var key = ev.target.parentElement.parentElement.parentElement.parentElement.parentElement.getAttribute("data-key");
        ev.dataTransfer.setData("drawable-image-key", key);
    }

    function onDrawableDrag(ev) {
        ev.dataTransfer.setData("drawable-container-key", ev.target.getAttribute("data-key"));
    }

    function onDrawableDrog(ev) {

        ev.preventDefault();

        // 拿到一个 drawable 的key
        var key = ev.dataTransfer.getData("drawable-container-key");

        // console.log("key = " + key);

        if (key == null || key == "" || key.toLocaleLowerCase() == "null") {
            key = ev.dataTransfer.getData("drawable-image-key");
        }

        if (key == null || key == "" || key.toLocaleLowerCase() == "null") {
            return;
        }

        // 拿到拖拽过来的 drawable 对应的数据
        var drawableEntity = mapDrawable[key]

        // 拿到拖拽的目标类别名称
        var targetCategoryName = ev.target.innerText;
        var originalCategoryName = drawableEntity.drawableCategory.name;

        if (targetCategoryName == originalCategoryName) { // 表示拖到了同一个类别下
            alert("不能移动到同一类别!请选择其他类别")
        } else {

            var sourceCategory = originalCategoryName;
            var source = drawableEntity.drawableName;
            var targetCategory = targetCategoryName;

            req({
                    type: 'PUT',
                    url: baseUrl + "action?sourceCategory=" + sourceCategory + "&source=" + source + "&targetCategory=" + targetCategory
                }, function (result) {

                    alert(result);

                }, function (msg) {

                    alert("msg = " + msg)

                }
            )
        }

        // console.log("ev.target.innerText = " + ev.target.innerText);
        // console.log("drawableEntity = " + drawableEntity);
        // console.log("drawableEntity.string = " + JSON.stringify(drawableEntity));
        // console.log("drawableEntity.drawableName = " + drawableEntity.drawableName);

        //ev.target.appendChild(document.getElementById(data));

    }

    // =============================== 有关拖动的 end=================================

</script>

</html>